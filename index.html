<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>News</title>
</head>
<body>
    <script>
        (async function displayJson(){
            let json=await getNewsData()
            let jsonElement = document.createElement("pre");
            document.body.appendChild(jsonElement)
            jsonElement.innerHTML=json
        })()
        async function getNewsData(){
            let doc =await getNews()
            let items= extractNews(doc)
            return JSON.stringify(items)
        }
        async function getNews(){
            try{
            let response= await fetch('https://cors-anywhere.herokuapp.com/https://baomoi.com/tim-kiem/bts.epi')
            let html = await response.text()
            let parser=new DOMParser()
            let doc= parser.parseFromString(html, "text/html");
            return doc
            } catch(e){console.log(e)}
            
        }
        function timeSince(timeStamp) {
            var now = new Date(),
            secondsPast = (now.getTime() - timeStamp.getTime()) / 1000;
            if(secondsPast < 60){
            return parseInt(secondsPast) + 's';
            }
            if(secondsPast < 3600){
            return parseInt(secondsPast/60) + 'm';
            }
            if(secondsPast <= 86400){
            return parseInt(secondsPast/3600) + 'h';
            }
            if(secondsPast > 86400){
                day = timeStamp.getDate();
                month = timeStamp.toDateString().match(/ [a-zA-Z]*/)[0].replace(" ","");
                year = timeStamp.getFullYear() == now.getFullYear() ? "" :  " "+timeStamp.getFullYear();
                return day + " " + month + year;
            }
        }
        function extractNews(doc){
            let container =Array.from(doc.querySelectorAll(".story"))
            for( var i = 0; i < container.length; i++){ 
            if (container[i].firstElementChild===null || container[i].getAttribute("class").includes("is-pr")) {
                container.splice(i, 1); 
            }
            }
            let images= container.map(x=>{
            if(x.firstElementChild.firstElementChild.firstElementChild!==null){
            return x.firstElementChild.firstElementChild.firstElementChild.src
            } else {
            return ""
            }
            })
            let imageLinks=images.map(x=>{
            if(x && x!==""){
                return x.substring(0,x.indexOf("w"))+x.substring(x.indexOf("_r")+6)
            } else {return ""}
            })
            let titlesAndLinks=container.map(x=>x.firstElementChild.nextElementSibling.firstElementChild)
            let titles=titlesAndLinks.map(x=>x.getAttribute("title"))
            let newsLinks=titlesAndLinks.map(x=>x.href)
            let metaData=container.map(x=>x.firstElementChild.nextElementSibling.nextElementSibling)
            let sources=metaData.map(x=>x.firstElementChild.innerText)
            let timesISO=metaData.map(x=> x.firstElementChild.nextElementSibling.getAttribute("datetime"))
            let times=timesISO.map(x=>{
                return timeSince(new Date(x))
            })

            //loc tin bts
            let conditions = ["bts", "jin", "jimin","rm","suga","jungkook","j-hope", "army", " v "];
            for( var i = 0; i < container.length; i++){ 
            if (
                !conditions.some(el=>titles[i].toLowerCase().includes(el))
            ){
                titles[i]=null
                newsLinks[i]=null
                imageLinks[i]=null
                sources[i]=null
                times[i]=null
            } else {
                titles[i]=titles[i]
                newsLinks[i]=newsLinks[i]
                imageLinks[i]=imageLinks[i]
                sources[i]=sources[i]
                times[i]=times[i]
            }
            }
            titles = titles.filter(function (el) {
            return el != null;
            });
            newsLinks = newsLinks.filter(function (el) {
            return el != null;
            });
            imageLinks = imageLinks.filter(function (el) {
            return el != null;
            });
            sources = sources.filter(function (el) {
            return el != null;
            });
            times = times.filter(function (el) {
            return el != null;
            });

            let items=[]
            for (let i=0;i<titles.length;i++){
            
                let singleItemInfo=
                {
                "newsLink":newsLinks[i]
                ,
                "imageLink":imageLinks[i]
                ,
                "title":titles[i]
                ,
                "source":sources[i]
                ,
                "time":times[i]
            
                }
                items[i]=singleItemInfo
            } 
            
            // }
            
            return items
        }

    </script>
</body>
</html>
